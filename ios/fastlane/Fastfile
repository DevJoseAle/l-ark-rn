# ios/fastlane/Fastfile

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

platform :ios do
  
  # ğŸ”§ Pre-check antes de cada lane
  before_all do
    # Verificar que Git estÃ© limpio (desactivado para desarrollo)
    # ensure_git_status_clean
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ§ª DESARROLLO
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  desc "Build para testing local en dispositivo"
  lane :dev do
    puts "ğŸ”¨ Generando build de desarrollo..."
    
    # Incrementar build number automÃ¡ticamente
    increment_build_number(xcodeproj: "lark.xcodeproj")
    
    # Build
    build_app(
      scheme: "lark",
      export_method: "development",
      output_directory: "./builds",
      output_name: "lark-dev-#{lane_context[SharedValues::BUILD_NUMBER]}.ipa",
      clean: true,
      export_options: {
        compileBitcode: false
      }
    )
    
    # Mostrar ubicaciÃ³n del IPA
    ipa_path = lane_context[SharedValues::IPA_OUTPUT_PATH]
    puts "âœ… Build completado exitosamente!"
    puts "ğŸ“¦ IPA ubicado en: #{ipa_path}"
    puts ""
    puts "Para instalar en tu dispositivo:"
    puts "1. Conecta tu iPhone/iPad"
    puts "2. Abre Xcode â†’ Window â†’ Devices and Simulators"
    puts "3. Arrastra el archivo .ipa a tu dispositivo"
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸš€ BETA (TestFlight)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  desc "Build y subir a TestFlight para beta testing"
  lane :beta do
    puts "ğŸš€ Preparando build para TestFlight..."
    
    # Incrementar build number
    increment_build_number(xcodeproj: "lark.xcodeproj")
    
    # Obtener versiÃ³n actual
    version = get_version_number(xcodeproj: "lark.xcodeproj")
    build = get_build_number(xcodeproj: "lark.xcodeproj")
    
    puts "ğŸ“± VersiÃ³n: #{version} (#{build})"
    
    # Build para App Store
    build_app(
      scheme: "lark",
      export_method: "app-store",
      output_directory: "./builds",
      output_name: "lark-testflight-#{version}-#{build}.ipa",
      clean: true
    )
    
    # Subir a TestFlight
    puts "ğŸ“¤ Subiendo a TestFlight..."
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      skip_submission: true,
      distribute_external: false,
      notify_external_testers: false,
      changelog: "Nueva versiÃ³n de prueba"
    )
    
    puts "âœ… Build subido exitosamente a TestFlight!"
    puts ""
    puts "PrÃ³ximos pasos:"
    puts "1. Ve a App Store Connect: https://appstoreconnect.apple.com"
    puts "2. Selecciona L-ark â†’ TestFlight"
    puts "3. Espera ~5-10 min a que Apple procese el build"
    puts "4. Agrega testers internos o externos"
    puts "5. Distribuye el build a tus testers"
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ“¦ PRODUCCIÃ“N (App Store)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  desc "Build para producciÃ³n (App Store)"
  lane :release do
    puts "ğŸ“¦ Preparando build de producciÃ³n..."
    
    # Incrementar build number
    increment_build_number(xcodeproj: "lark.xcodeproj")
    
    # Obtener versiÃ³n
    version = get_version_number(xcodeproj: "lark.xcodeproj")
    build = get_build_number(xcodeproj: "lark.xcodeproj")
    
    puts "ğŸ“± VersiÃ³n de producciÃ³n: #{version} (#{build})"
    
    # Build
    build_app(
      scheme: "lark",
      export_method: "app-store",
      clean: true
    )
    
    # Subir a App Store
    puts "ğŸ“¤ Subiendo a App Store Connect..."
    upload_to_app_store(
      skip_metadata: true,
      skip_screenshots: true,
      submit_for_review: false,
      automatic_release: false,
      force: true
    )
    
    puts "âœ… Build de producciÃ³n subido!"
    puts "Ve a App Store Connect para completar la informaciÃ³n y enviar a revisiÃ³n"
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ”¢ GESTIÃ“N DE VERSIONES
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  desc "Incrementar version number"
  lane :bump do |options|
    type = options[:type] || "patch" # patch, minor, major
    
    increment_version_number(
      bump_type: type,
      xcodeproj: "lark.xcodeproj"
    )
    
    version = get_version_number(xcodeproj: "lark.xcodeproj")
    puts "âœ… Nueva versiÃ³n: #{version}"
    
    # Opcional: Commit del cambio
    # git_commit(
    #   path: ["lark.xcodeproj/project.pbxproj"],
    #   message: "Bump version to #{version}"
    # )
  end

  desc "Mostrar versiÃ³n actual"
  lane :version do
    version = get_version_number(xcodeproj: "lark.xcodeproj")
    build = get_build_number(xcodeproj: "lark.xcodeproj")
    
    puts "ğŸ“± L-ark"
    puts "VersiÃ³n: #{version}"
    puts "Build: #{build}"
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ§¹ UTILIDADES
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  desc "Limpiar archivos de build y cachÃ©"
  lane :clean do
    puts "ğŸ§¹ Limpiando archivos de build..."
    
    # Limpiar builds anteriores
    sh("rm -rf ./builds") if File.directory?("./builds")
    sh("rm -rf ./derived_data") if File.directory?("./derived_data")
    
    # Limpiar build artifacts
    clean_build_artifacts
    
    # Limpiar DerivedData de Xcode
    sh("rm -rf ~/Library/Developer/Xcode/DerivedData/lark-*")
    
    puts "âœ… Limpieza completada"
  end

  desc "Abrir proyecto en Xcode"
  lane :xcode do
    sh("open lark.xcworkspace")
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ” CERTIFICADOS (Opcional - Fastlane Match)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  # Descomenta si usas Fastlane Match para certificados
  # desc "Sincronizar certificados de desarrollo"
  # lane :sync_dev_certs do
  #   match(type: "development", readonly: true)
  # end

  # desc "Sincronizar certificados de App Store"
  # lane :sync_appstore_certs do
  #   match(type: "appstore", readonly: true)
  # end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # âŒ ERROR HANDLER
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  error do |lane, exception|
    puts ""
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "âŒ Error en lane '#{lane}'"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts exception.message
    puts ""
    
    # AquÃ­ podrÃ­as enviar notificaciÃ³n a Slack, Discord, etc.
  end

end